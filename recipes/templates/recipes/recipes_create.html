{% extends "recipes/base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-3">
    <div class="row">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="col mx-auto">
                <h2 class="mb-3">Submit a Recipe</h2>
                {{ form|crispy }}
            </div>

            <div class="col mx-auto">
                <h3>Ingredients</h3>
                <div id="ingredients-container">
                    {{ ingredientFormSet.management_form }}
                    {% for form in ingredientFormSet.forms %}
                    <div class="ingredient-form form-row">
                        {{ form|crispy }}
                        <div class="delete-checkbox">
                            {{ form.DELETE }} <!-- Or whatever your template code is for the checkbox -->
                        </div>
                    </div>
                    {% endfor %}
                    <button type="button" id="add-ingredient" class="btn btn-success mb-3">Add Ingredient</button>
                </div>

                <h3>Steps</h3>
                <div id="steps-container">
                    {{ stepFormSet.management_form }}
                    {% for form in stepFormSet.forms %}
                    <div class="step-form form-row">
                        {{ form|crispy }}
                    </div>
                    {% endfor %}
                    <button type="button" id="add-step" class="btn btn-success mb-3">Add Step</button>
                </div>
            </div>

            <div class="col form-group mx-auto">
                <button type="submit" class="d-block btn btn-primary ms-auto">Submit Recipe</button>
            </div>
        </form>
    </div>
</div>

<!-- Hidden templates for cloning, outside the main form UI -->
<div id="empty-ingredient-form" style="display:none;">
    {{ ingredientFormSet.empty_form|crispy }}
</div>

<div id="empty-step-form" style="display:none;">
    {{ stepFormSet.empty_form|crispy }}
</div>

{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    $(document).ready(function () {
        // Function to add a new form row
        function addFormRow(containerSelector, prefix) {
            const container = $(containerSelector);
            const totalForms = $('#id_' + prefix + '-TOTAL_FORMS');
            let formNum = parseInt(totalForms.val());
            const newForm = container.find('.form-row:first').clone(true).removeClass('d-none');

            // Clear the values in the cloned form and update its index
            newForm.find(':input').each(function () {
                let name = $(this).attr('name');
                if (name) {
                    name = name.replace('-0-', '-' + formNum + '-');
                    const id = 'id_' + name;
                    $(this).attr({ 'name': name, 'id': id }).val('').removeAttr('checked');
                }
            });

            // Increment the TOTAL_FORMS count
            totalForms.val(formNum + 1);

            // Append the remove button to the new form and append the new form to the container
            newForm.append('<button type="button" class="remove-form-row btn btn-danger mb-3">Remove</button>');
            container.append(newForm);

            // Bind the remove function to the new remove button
            newForm.find('.remove-form-row').click(function () {
                $(this).closest('.form-row').remove();
                // Decrement the TOTAL_FORMS count after removing
                totalForms.val(parseInt(totalForms.val()) - 1);
            });
        }

        // Attach the addFormRow function to 'Add ingredient' and 'Add step' buttons
        $('#add-ingredient').click(function () {
            addFormRow('#ingredients-container', 'ingredient');
        });
        $('#add-step').click(function () {
            addFormRow('#steps-container', 'step');
        });

        // Initial form rows won't have a remove button, so no need to hide them manually
    });
</script>
{% endblock %}